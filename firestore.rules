rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Fonction helper pour vérifier si l'utilisateur est admin
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Fonction helper pour vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }

    // ==================== COLLECTIONS PUBLIQUES (lecture seule) ====================

    // Annonces - Lecture publique, écriture admin
    match /announcements/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Événements - Lecture publique, écriture admin
    match /events/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Janaza - Lecture publique, écriture admin
    match /janaza/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Projets - Lecture publique, écriture admin
    match /projects/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Popups - Lecture publique, écriture admin
    match /popups/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Rappels du jour - Lecture publique, écriture admin
    match /rappels/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Dates islamiques - Lecture publique, écriture admin
    match /dates_islamiques/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Settings (horaires, infos mosquée) - Lecture publique, écriture admin
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==================== COLLECTIONS PROTÉGÉES ====================

    // Membres - Lecture/écriture pour le membre lui-même ou admin
    match /members/{memberId} {
      allow read: if isAuthenticated() && (request.auth.uid == memberId || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (request.auth.uid == memberId || isAdmin());
    }

    // Dons - Lecture admin, création authentifiée
    match /donations/{docId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // Admins - Accès super admin uniquement
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin';
    }

    // Notifications (pour le backoffice) - Admin uniquement
    match /notifications/{docId} {
      allow read, write: if isAdmin();
    }

    // Historique des notifications - Admin uniquement
    match /notifications_history/{docId} {
      allow read: if isAdmin();
      allow write: if false; // Écriture uniquement via Cloud Functions
    }

    // ==================== RÈGLE PAR DÉFAUT ====================

    // Refuser tout accès non explicitement autorisé
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
